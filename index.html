<head>
  <!-- avoid text rendering issues on various platforms -->
  <meta charset="utf-8" />

  <!-- prevent auto-zooming on mobile browsers -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Font Awesome -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    rel="stylesheet"
  />

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <!-- Pug template compiler -->
  <script src="https://pugjs.org/js/pug.js"></script>
  <script>
    window.pug = require("pug");

    function renderHtmlFromPug(str) {
      const lines = str.replace(/^\n/, "").split("\n");
      const minIndent = Math.min(
        ...lines.filter((l) => l.trim()).map((l) => l.match(/^\s*/)[0].length),
      );
      return pug.render(lines.map((l) => l.slice(minIndent)).join("\n"));
    }
  </script>

  <!-- Lodash -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.min.js"></script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Ky -->
  <script type="module">
    import ky from "https://unpkg.com/ky/distribution/index.js";
    window.ky = ky;
  </script>

  <script src="graph-data.js"></script>
</head>

<body>
  <div id="app"></div>
</body>

<script>
  // language=pug
  let template = renderHtmlFromPug(`
    .text-center
      .mt-5
      h1
        i.fas.fa-chart-bar.me-2
        | {{ title }}

      .mt-3
        button.btn.btn-primary(type="button" data-bs-toggle="modal" data-bs-target="#info-modal")
          | More Info
      .mt-4
        .row.justify-content-center
          template(v-for="graph in graphs" :key="graph.id")
            .col-12.mb-4
              .card.px-3.py-3.mx-5
                div(:id="graph.id")
      .mt-4
        .row.justify-content-center
          .col-md-8
            .card.p-3
              h5.card-title API Data Example
              p.text-muted Fetching data from: {{ url }}
              .text-start
                pre.bg-light.p-2.small.overflow-auto(style="max-height: 300px") {{ JSON.stringify(downloadData, null, 2) }}

      .pb-5
      .pb-5

      .modal.fade#info-modal(tabindex="-1" aria-labelledby="info-modal-label" aria-hidden="true")
        .modal-dialog
          .modal-content
            .modal-header
              h5.modal-title#info-modal-label About OnePageApp
              button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
            .modal-body.text-start
              p This is a comprehensive one-page HTML template featuring pre-loaded libraries:
              ul.text-start
                li Vue 3 - Progressive JavaScript framework
                li Bootstrap 5 - CSS framework for responsive design
                li Font Awesome - Icon library
                li Pug - Template engine for cleaner HTML
                li Lodash - Utility library
                li Plotly.js - Interactive charting library
                li Ky - Modern HTTP client
            .modal-footer
              button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Close

  `);

  const { createApp, ref, onMounted } = Vue;

  function deepCamelCaseKeys(value) {
    if (_.isArray(value)) {
      return value.map(deepCamelCaseKeys);
    }
    if (_.isPlainObject(value)) {
      const camelKeyed = _.mapKeys(value, (v, k) => _.camelCase(k));
      return _.mapValues(camelKeyed, deepCamelCaseKeys);
    }
    return value;
  }

  function plotGraphs(graphs) {
    for (let graph of graphs) {
      const element = document.getElementById(graph.id);
      if (element) {
        Plotly.newPlot(element, graph);
      }
    }
  }

  async function getJson(url) {
    let result;
    try {
      result = await ky.get(url).json();
    } catch (error) {
      console.error("Failed to fetch data:", error);
      result = { error: "Failed to load data" };
    }
    return deepCamelCaseKeys(result);
  }

  function setup() {
    const title = ref("OnePageApp");
    const graphs = ref(deepCamelCaseKeys(window.graphs) || []);
    const url = ref("https://restcountries.com/v3.1/name/canada");
    const downloadData = ref({});

    onMounted(async () => {
      document.title = title.value;
      plotGraphs(graphs.value);
      downloadData.value = await getJson(url.value);
    });

    return {
      title,
      graphs,
      url,
      downloadData,
    };
  }

  document.addEventListener("DOMContentLoaded", () => {
    createApp({ template, setup }).mount("#app");
  });
</script>
